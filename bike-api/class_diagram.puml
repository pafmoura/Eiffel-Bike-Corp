@startuml
skinparam style strictuml
skinparam classAttributeIconSize 0

' =========================
' Enums
' =========================
enum BikeStatus {
  AVAILABLE
  RENTED
  MAINTENANCE
}

enum RentalStatus {
  ACTIVE
  CLOSED
  CANCELED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum SaleOfferStatus {
  LISTED
  SOLD
  REMOVED
}

enum BasketStatus {
  OPEN
  CHECKED_OUT
  ABANDONED
}

enum PurchaseStatus {
  CREATED
  PAID
  CANCELED
}

' =========================
' Core actors / identities
' =========================
abstract class BikeProvider {
  +id: UUID
}

class Student
class Employee
class EiffelBikeCorp

BikeProvider <|-- Student
BikeProvider <|-- Employee
BikeProvider <|-- EiffelBikeCorp

class Customer {
  +id: UUID
  +fullName: String
  +email: String
}

' =========================
' Bike & rental
' =========================
class Bike {
  +id: Long
  +description: String
  +status: BikeStatus
  +rentalDailyRateEur: BigDecimal
}

class Rental {
  +id: Long
  +startAt: LocalDateTime
  +endAt: LocalDateTime
  +status: RentalStatus
  +totalAmountEur: BigDecimal
}

class RentalPayment {
  +id: Long
  +originalAmount: BigDecimal
  +originalCurrency: String
  +fxRateToEur: BigDecimal
  +amountEur: BigDecimal
  +status: PaymentStatus
  +paidAt: LocalDateTime
  +stripePaymentIntentId: String
}

class ReturnNote {
  +id: Long
  +comment: String
  +condition: String
  +createdAt: LocalDateTime
}

Bike "0..*" --> "1" BikeProvider : offeredBy
Customer "1" --> "0..*" Rental : rents >
Bike     "1" --> "0..*" Rental : isRentedIn >
Rental "1" o-- "0..*" RentalPayment : payments
Rental "1" o-- "0..1" ReturnNote : returnNote
Customer "1" --> "0..*" ReturnNote : writes >

' =========================
' Waiting list
' =========================
class WaitingList {
  +id: Long
}

class WaitingListEntry {
  +id: Long
  +createdAt: LocalDateTime
  +servedAt: LocalDateTime
}

class Notification {
  +id: Long
  +message: String
  +sentAt: LocalDateTime
}

Bike "1" o-- "0..1" WaitingList : waitingList
WaitingList "1" o-- "0..*" WaitingListEntry : entries (FIFO)
Customer "1" --> "0..*" WaitingListEntry : joins >
WaitingListEntry "1" o-- "0..*" Notification : notifications >

' =========================
' Sale offers
' =========================
class SaleOffer {
  +id: Long
  +askingPriceEur: BigDecimal
  +status: SaleOfferStatus
  +listedAt: LocalDateTime
  +soldAt: LocalDateTime
}

class SaleNote {
  +id: Long
  +title: String
  +content: String
  +createdAt: LocalDateTime
  +createdBy: String
}

Bike "1" o-- "0..1" SaleOffer : saleOffer
SaleOffer "0..*" --> "1" EiffelBikeCorp : seller >
SaleOffer "0..1" --> "0..1" Customer : buyer >
SaleOffer "1" o-- "0..*" SaleNote : notes

' =========================
' Basket
' =========================
class Basket {
  +id: Long
  +status: BasketStatus
  +createdAt: LocalDateTime
  +updatedAt: LocalDateTime
}

class BasketItem {
  +id: Long
  +unitPriceEurSnapshot: BigDecimal
  +addedAt: LocalDateTime
}

Customer "1" --> "0..*" Basket : baskets >
Basket "1" o-- "0..*" BasketItem : items
BasketItem "0..*" --> "1" SaleOffer : offer >

' =========================
' Purchase (Order)
' =========================
class Purchase {
  +id: Long
  +status: PurchaseStatus
  +totalAmountEur: BigDecimal
  +createdAt: LocalDateTime
  +paidAt: LocalDateTime
}

class PurchaseItem {
  +id: Long
  +unitPriceEurSnapshot: BigDecimal
}

class SalePayment {
  +id: Long
  +originalAmount: BigDecimal
  +originalCurrency: String
  +fxRateToEur: BigDecimal
  +amountEur: BigDecimal
  +status: PaymentStatus
  +paidAt: LocalDateTime
  +stripePaymentIntentId: String
}

Customer "1" --> "0..*" Purchase : purchases >
Purchase "1" o-- "1..*" PurchaseItem : items
PurchaseItem "0..*" --> "1" SaleOffer : offer >
Purchase "1" o-- "0..*" SalePayment : payments

note right of SaleOffer
Only bikes that:
1) are offeredBy EiffelBikeCorp
2) have at least one Rental
can be LISTED
end note

@enduml
