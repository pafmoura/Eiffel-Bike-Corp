<!-- ALERT -->
<div *ngIf="alert().show"
     class="fixed top-6 right-6 z-[110]">
  <div [ngClass]="{
        'bg-emerald-50 border-emerald-500 text-emerald-800': alert().type === 'success',
        'bg-red-50 border-red-500 text-red-800': alert().type === 'error',
        'bg-blue-50 border-blue-500 text-blue-800': alert().type === 'info'
      }"
       class="flex items-center p-4 rounded-2xl border-l-4 shadow-xl min-w-[320px]">

    <div class="flex-1 mr-4">
      <p class="text-xs font-black uppercase tracking-widest opacity-60 mb-1">
        {{ alert().type }}
      </p>
      <p class="text-sm font-bold">
        {{ alert().message }}
      </p>
    </div>

    <button (click)="alert.set({show: false, message: '', type: 'info'})"
            class="text-xl font-bold opacity-50 hover:opacity-100">
      Ã—
    </button>
  </div>
</div>

<!-- PAGE -->
<div class="flex h-screen bg-slate-50 overflow-hidden font-sans">

  <!-- MAIN CONTENT -->
  <div class="flex-1 p-8 overflow-y-auto">

    <!-- HEADER -->
    <header class="flex justify-between items-center mb-8">
      <div>
        <h2 class="text-3xl font-extrabold text-slate-900">Bike Marketplace</h2>
        <p class="text-slate-500">Buy premium used bikes from the corporate fleet.</p>
      </div>

      <div class="flex items-center gap-4">
        <select
          [ngModel]="fx.currency()"
          (ngModelChange)="fx.setCurrency($event)"
          class="bg-white border rounded-xl px-3 py-2 text-sm font-bold shadow-sm outline-none">
          <option *ngFor="let c of fx.currencies()" [value]="c">{{ c }}</option>
        </select>

        <button (click)="isOpen.set(!isOpen())"
                class="bg-white p-3 rounded-xl border shadow-sm relative">
          ðŸ›’
          <span *ngIf="basketItems().length"
                class="absolute -top-1 -right-1 bg-indigo-600 text-white text-[10px]
                       w-5 h-5 flex items-center justify-center rounded-full">
            {{ basketItems().length }}
          </span>
        </button>
      </div>
    </header>

    <!-- SEARCH -->
    <input type="text"
           (input)="loadOffers($any($event.target).value)"
           placeholder="Search sales..."
           class="w-full md:w-96 px-4 py-3 mb-8 rounded-xl border shadow-sm">

    <!-- OFFERS GRID -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div *ngFor="let offer of offers()"
           class="bg-white p-4 rounded-2xl shadow border flex flex-col">

        <div class="h-40 bg-slate-100 rounded-xl mb-4 overflow-hidden relative">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQuqnSeZPqSaCHmM8Wj8fqD8bPkHKd1HODlCw&s"
               class="w-full h-full object-cover">
          <span class="absolute top-2 right-2 bg-green-500 text-white text-[10px]
                       px-2 py-1 rounded-md font-bold">
            {{ offer.availability }}
          </span>
        </div>

        <h3 class="font-bold text-lg">{{ getBikeDescription(offer.bikeId) }}</h3>
        <p class="text-xs text-slate-400 mb-4">Listing ID: {{ offer.id }}</p>

        <div class="mt-auto flex justify-between items-center">
          <span class="text-2xl font-black text-indigo-600">
            {{ fx.convert(offer.askingPriceEur) | currency: fx.currency() }}
          </span>

          <div class="flex gap-2">
            <button (click)="viewDetails(offer.id)"
                    class="px-3 py-2 bg-slate-100 rounded-lg text-xs font-bold">
              Details
            </button>

            <button *ngIf="isAddable(offer)"
                    (click)="addToBasket(offer.id)"
                    class="px-4 py-2 bg-slate-900 text-white rounded-lg font-bold">
              Add
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BACKDROP -->
  <div *ngIf="isOpen()"
       (click)="closeDrawer()"
       class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[80]">
  </div>

  <!-- BASKET DRAWER -->
  <div *ngIf="isOpen()"
       class="fixed top-0 right-0 h-full w-[420px] bg-white z-[90]
              shadow-2xl border-l flex flex-col">

    <!-- HEADER -->
    <div class="p-6 border-b bg-slate-50 flex justify-between items-center">
      <div>
        <p class="text-xs uppercase tracking-widest text-slate-400 font-bold">
          {{ isPaymentStep() ? 'Payment' : 'Basket' }}
        </p>
        <h3 class="font-black text-xl">
          {{ isPaymentStep() ? 'Secure Checkout' : 'Your Bikes' }}
        </h3>
      </div>

      <button (click)="closeDrawer()"
              class="w-8 h-8 flex items-center justify-center rounded-full
                     hover:bg-slate-200 text-slate-500 font-bold">
        Ã—
      </button>
    </div>

    <!-- CONTENT -->
    <div class="flex-1 p-6 overflow-y-auto space-y-4">

      <div *ngIf="basketItems().length === 0"
           class="text-center text-slate-400 mt-20">
        Your basket is empty
      </div>

      <!-- BASKET ITEMS -->
      <ng-container *ngIf="!isPaymentStep()">
        <div *ngFor="let item of basketItems()"
             class="p-4 rounded-2xl border bg-white shadow-sm
                    flex justify-between items-center">
          <div>
            <p class="font-black text-sm">Bike #{{ item.bikeId }}</p>
            <p class="text-xs text-slate-400">Corporate Fleet</p>
            <p class="text-indigo-600 font-black text-sm mt-1">
              {{ fx.convert(item.unitPriceEurSnapshot) | currency: fx.currency() }}
            </p>
          </div>

          <button (click)="remove(item.saleOfferId || item.id)"
                  class="text-red-500 text-lg">
            ðŸ—‘
          </button>
        </div>
      </ng-container>

      <!-- PAYMENT -->
      <ng-container *ngIf="isPaymentStep()">
        <div class="space-y-6">

          <div class="p-4 bg-indigo-50 rounded-xl border">
            <label class="text-[10px] uppercase font-bold text-indigo-400">
              Total Due
            </label>
            <p class="text-3xl font-black text-indigo-700">
              {{ fx.convert(totalEur()) | currency: fx.currency() }}
            </p>
          </div>

          <form (ngSubmit)="confirmPayment()" autocomplete="cc-number">
            <div class="space-y-4">

              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">
                  CARD NUMBER
                </label>
                <input name="cc-number" autocomplete="cc-number"
                       [value]="cardNumber()"
                       (input)="cardNumber.set($any($event.target).value)"
                       placeholder="4242 4242 4242 4242"
                       class="w-full p-3 border rounded-lg">
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-bold text-slate-500 mb-1">
                    EXPIRY
                  </label>
                  <input name="cc-exp" autocomplete="cc-exp"
                         [value]="expiry()"
                         (input)="expiry.set($any($event.target).value)"
                         placeholder="MM / YY"
                         class="w-full p-3 border rounded-lg">
                </div>

                <div>
                  <label class="block text-xs font-bold text-slate-500 mb-1">
                    CVC
                  </label>
                  <input name="cc-csc" autocomplete="cc-csc"
                         [value]="cvc()"
                         (input)="cvc.set($any($event.target).value)"
                         placeholder="CVC"
                         class="w-full p-3 border rounded-lg">
                </div>
              </div>
            </div>

            <button type="submit"
                    class="w-full mt-6 py-4 bg-green-600
                           text-white rounded-xl font-bold">
              Authorize & Pay
              {{ fx.convert(totalEur()) | currency: fx.currency() }}
            </button>
          </form>
        </div>
      </ng-container>
    </div>

    <!-- FOOTER -->
    <div class="p-6 bg-white border-t sticky bottom-0">

      <button *ngIf="!isPaymentStep()"
              (click)="startCheckout()"
              class="w-full py-4 bg-indigo-600
                     text-white rounded-xl font-bold">
        Checkout ({{ fx.convert(totalEur()) | currency: fx.currency() }})
      </button>

      <button *ngIf="isPaymentStep()"
              (click)="isPaymentStep.set(false)"
              class="w-full mt-2 text-xs text-slate-400">
        Back to Basket
      </button>
    </div>
  </div>

  <!-- DETAILS MODAL -->
  <div *ngIf="selectedOffer()"
       class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100]
              flex items-center justify-center">
    <div class="bg-white rounded-3xl max-w-lg w-full shadow-2xl overflow-hidden">
      <div class="p-6 border-b flex justify-between">
        <h3 class="font-bold text-xl">Condition & Notes</h3>
        <button (click)="selectedOffer.set(null)">Ã—</button>
      </div>

      <div class="p-6 space-y-4 max-h-[50vh] overflow-y-auto">
        <div *ngFor="let note of selectedOffer().notes"
             class="p-4 bg-slate-50 rounded-xl border">
          <h4 class="font-bold text-indigo-600 text-sm">
            {{ note.title }}
          </h4>
          <p class="text-sm">
            {{ note.content }}
          </p>
        </div>
      </div>
    </div>
  </div>

</div>
